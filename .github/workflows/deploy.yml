name: Build and Deploy to App Service

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  AZURE_LOCATION: westus3
  AZURE_ENV_NAME: dev
  CONTAINER_IMAGE_NAME: zava-storefront
  RESOURCE_GROUP: zava-dev

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Authenticate with Azure using OIDC
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # Get ACR details dynamically
      - name: Get ACR details
        id: acr
        run: |
          acr_name=$(az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type Microsoft.ContainerRegistry/registries \
            --query "[0].name" -o tsv)
          
          app_service=$(az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type Microsoft.Web/sites \
            --query "[0].name" -o tsv)
          
          echo "acr_name=$acr_name" >> $GITHUB_OUTPUT
          echo "app_service=$app_service" >> $GITHUB_OUTPUT
          echo "ACR Name: $acr_name"
          echo "App Service: $app_service"
      
      # Build and push image to ACR using cloud-based build (no local Docker required)
      - name: Build and push image to ACR
        run: |
          az acr build \
            --registry ${{ steps.acr.outputs.acr_name }} \
            --image ${{ env.CONTAINER_IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.CONTAINER_IMAGE_NAME }}:latest \
            --file Dockerfile \
            .
      
      # Get App Service configuration details
      - name: Get App Service details
        id: appservice
        run: |
          app_resource_id=$(az resource list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --resource-type Microsoft.Web/sites \
            --query "[0].id" -o tsv)
          echo "app_id=$app_resource_id" >> $GITHUB_OUTPUT
      
      # Deploy image to App Service
      - name: Deploy to App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.acr.outputs.app_service }}
          images: ${{ steps.acr.outputs.acr_name }}.azurecr.io/${{ env.CONTAINER_IMAGE_NAME }}:${{ github.sha }}
      
      # Wait for deployment to complete and verify
      - name: Verify deployment
        run: |
          echo "Deployment to ${{ steps.acr.outputs.app_service }} completed"
          echo "Image: ${{ steps.acr.outputs.acr_name }}.azurecr.io/${{ env.CONTAINER_IMAGE_NAME }}:${{ github.sha }}"
  
  notify:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always()
    
    steps:
      - name: Deployment succeeded
        if: needs.build-and-deploy.result == 'success'
        run: echo "✅ Application successfully deployed to App Service"
      
      - name: Deployment failed
        if: needs.build-and-deploy.result == 'failure'
        run: |
          echo "❌ Deployment failed"
          exit 1
