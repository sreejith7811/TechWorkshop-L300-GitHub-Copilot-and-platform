{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "12084942447580604961"
    }
  },
  "parameters": {
    "keyVaultName": {
      "type": "string",
      "defaultValue": "[format('kvzavastore{0}', uniqueString(resourceGroup().id))]",
      "minLength": 3,
      "maxLength": 24
    },
    "location": {
      "type": "string",
      "defaultValue": "westus3"
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev"
    },
    "projectName": {
      "type": "string",
      "defaultValue": "zavastore"
    },
    "acrName": {
      "type": "string",
      "defaultValue": "[format('acrzavastore{0}', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Container Registry name (must be globally unique, lowercase alphanumeric only)"
      }
    },
    "acrSku": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "appServicePlanName": {
      "type": "string",
      "defaultValue": "[format('asp-zavastore-{0}', parameters('environment'))]"
    },
    "webAppName": {
      "type": "string",
      "defaultValue": "[format('app-zavastore-{0}-{1}', parameters('environment'), uniqueString(resourceGroup().id))]"
    },
    "appServicePlanTier": {
      "type": "string",
      "defaultValue": "Basic"
    },
    "appServicePlanSize": {
      "type": "string",
      "defaultValue": "B1"
    },
    "appInsightsName": {
      "type": "string",
      "defaultValue": "[format('appi-zavastore-{0}', parameters('environment'))]"
    },
    "containerImageName": {
      "type": "string",
      "defaultValue": "zava-storefront"
    },
    "containerImageTag": {
      "type": "string",
      "defaultValue": "latest"
    },
    "containerPort": {
      "type": "int",
      "defaultValue": 5000
    },
    "microsoftFoundryName": {
      "type": "string",
      "defaultValue": "[format('mf-zavastore-{0}', parameters('environment'))]"
    },
    "enableAppInsights": {
      "type": "bool",
      "defaultValue": true
    },
    "enableKeyVault": {
      "type": "bool",
      "defaultValue": true
    },
    "enableMicrosoftFoundry": {
      "type": "bool",
      "defaultValue": true
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "environment": "[parameters('environment')]",
        "project": "[parameters('projectName')]",
        "createdBy": "Bicep",
        "region": "[parameters('location')]",
        "costCenter": "dev"
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerRegistry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "acrName": {
            "value": "[parameters('acrName')]"
          },
          "sku": {
            "value": "[parameters('acrSku')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "11891398446095905330"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "acrName": {
              "type": "string"
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "Enabled"
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('acrName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "adminUserEnabled": false,
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "retentionPolicy": {
                    "status": "disabled"
                  },
                  "trustPolicy": {
                    "type": "Notary",
                    "status": "disabled"
                  }
                },
                "networkRuleBypassOptions": "AzureServices"
              }
            }
          ],
          "outputs": {
            "registryId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]"
            },
            "registryName": {
              "type": "string",
              "value": "[parameters('acrName')]"
            },
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2023-07-01').loginServer]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableAppInsights')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "applicationInsights",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appInsightsName": {
            "value": "[parameters('appInsightsName')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "8620274173406995957"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            },
            "retentionDays": {
              "type": "int",
              "defaultValue": 30
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-log', parameters('appInsightsName'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": "[parameters('retentionDays')]",
                "features": {
                  "searchVersion": 1,
                  "legacy": 0,
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "RetentionInDays": "[parameters('retentionDays')]",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-log', parameters('appInsightsName')))]",
                "IngestionMode": "LogAnalytics"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-log', parameters('appInsightsName')))]"
              ]
            },
            {
              "type": "Microsoft.Insights/actionGroups",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}-ag', parameters('appInsightsName'))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "groupShortName": "ZavaAI",
                "enabled": true
              }
            },
            {
              "type": "Microsoft.Insights/metricAlerts",
              "apiVersion": "2018-03-01",
              "name": "[format('{0}-request-rate-alert', parameters('appInsightsName'))]",
              "location": "global",
              "tags": "[parameters('tags')]",
              "properties": {
                "description": "Alert when request rate is high",
                "severity": 3,
                "enabled": true,
                "scopes": [
                  "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
                ],
                "evaluationFrequency": "PT5M",
                "windowSize": "PT15M",
                "criteria": {
                  "odata.type": "Microsoft.Azure.Monitor.MultipleResourceMultipleMetricCriteria",
                  "allOf": [
                    {
                      "name": "RequestsPerSecond",
                      "metricName": "requests/rate",
                      "operator": "GreaterThan",
                      "threshold": 100,
                      "timeAggregation": "Average",
                      "skipMetricValidation": false,
                      "criterionType": "StaticThresholdCriterion"
                    }
                  ]
                },
                "actions": [
                  {
                    "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', format('{0}-ag', parameters('appInsightsName')))]",
                    "webHookProperties": {}
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/actionGroups', format('{0}-ag', parameters('appInsightsName')))]",
                "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "appInsightsName": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-log', parameters('appInsightsName')))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appService",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "appServicePlanName": {
            "value": "[parameters('appServicePlanName')]"
          },
          "webAppName": {
            "value": "[parameters('webAppName')]"
          },
          "acrLoginServer": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry'), '2025-04-01').outputs.loginServer.value]"
          },
          "containerImageName": {
            "value": "[parameters('containerImageName')]"
          },
          "containerImageTag": {
            "value": "[parameters('containerImageTag')]"
          },
          "containerPort": {
            "value": "[parameters('containerPort')]"
          },
          "appServicePlanTier": {
            "value": "[parameters('appServicePlanTier')]"
          },
          "appServicePlanSize": {
            "value": "[parameters('appServicePlanSize')]"
          },
          "appInsightsInstrumentationKey": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsights'), '2025-04-01').outputs.instrumentationKey.value), createObject('value', ''))]",
          "appInsightsConnectionString": "[if(parameters('enableAppInsights'), createObject('value', reference(resourceId('Microsoft.Resources/deployments', 'applicationInsights'), '2025-04-01').outputs.connectionString.value), createObject('value', ''))]",
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "1014868406624056371"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "appServicePlanName": {
              "type": "string"
            },
            "webAppName": {
              "type": "string"
            },
            "acrLoginServer": {
              "type": "string"
            },
            "containerImageName": {
              "type": "string"
            },
            "containerImageTag": {
              "type": "string"
            },
            "containerPort": {
              "type": "int",
              "defaultValue": 5000
            },
            "appServicePlanTier": {
              "type": "string",
              "defaultValue": "Basic"
            },
            "appServicePlanSize": {
              "type": "string",
              "defaultValue": "B1"
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "defaultValue": ""
            },
            "appInsightsConnectionString": {
              "type": "string",
              "defaultValue": ""
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "linux",
              "sku": {
                "name": "[parameters('appServicePlanSize')]",
                "tier": "[parameters('appServicePlanTier')]"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('webAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "app,linux,container",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                  "linuxFxVersion": "[format('DOCKER|{0}/{1}:{2}', parameters('acrLoginServer'), parameters('containerImageName'), parameters('containerImageTag'))]",
                  "alwaysOn": true,
                  "minTlsVersion": "1.2",
                  "appSettings": [
                    {
                      "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                      "value": "false"
                    },
                    {
                      "name": "DOCKER_REGISTRY_SERVER_URL",
                      "value": "[format('https://{0}', parameters('acrLoginServer'))]"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "ApplicationInsightsAgent_EXTENSION_VERSION",
                      "value": "~3"
                    },
                    {
                      "name": "WEBSITES_PORT",
                      "value": "[string(parameters('containerPort'))]"
                    }
                  ],
                  "healthCheckPath": "/"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/config",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('webAppName'), 'web')]",
              "properties": {
                "minTlsVersion": "1.2",
                "scmMinTlsVersion": "1.2",
                "http20Enabled": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
              ]
            }
          ],
          "outputs": {
            "webAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
            },
            "webAppName": {
              "type": "string",
              "value": "[parameters('webAppName')]"
            },
            "webAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01').defaultHostName)]"
            },
            "managedIdentityPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('webAppName')), '2023-01-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'applicationInsights')]",
        "[resourceId('Microsoft.Resources/deployments', 'containerRegistry')]"
      ]
    },
    {
      "condition": false,
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "roleAssignment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acrId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry'), '2025-04-01').outputs.registryId.value]"
          },
          "webAppPrincipalId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.managedIdentityPrincipalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "18347196082001740011"
            }
          },
          "parameters": {
            "acrId": {
              "type": "string"
            },
            "webAppPrincipalId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[resourceId('Microsoft.ContainerRegistry/registries', split(parameters('acrId'), '/')[8])]",
              "name": "[guid(resourceGroup().id, resourceId('Microsoft.ContainerRegistry/registries', split(parameters('acrId'), '/')[8]), parameters('webAppPrincipalId'))]",
              "properties": {
                "roleDefinitionId": "[format('/subscriptions/{0}/providers/Microsoft.Authorization/roleDefinitions/7f951dda4ed34680a7ca6e2dd633aa60', subscription().subscriptionId)]",
                "principalId": "[parameters('webAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', split(parameters('acrId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(resourceGroup().id, resourceId('Microsoft.ContainerRegistry/registries', split(parameters('acrId'), '/')[8]), parameters('webAppPrincipalId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(resourceGroup().id, resourceId('Microsoft.ContainerRegistry/registries', split(parameters('acrId'), '/')[8]), parameters('webAppPrincipalId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appService')]",
        "[resourceId('Microsoft.Resources/deployments', 'containerRegistry')]"
      ]
    },
    {
      "condition": "[parameters('enableKeyVault')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyVault",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "14843868539486077862"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "keyVaultName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "accessPolicies": [],
                "enablePurgeProtection": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enableRbacAuthorization": true,
                "publicNetworkAccess": "Enabled",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      }
    },
    {
      "condition": "[parameters('enableMicrosoftFoundry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "microsoftFoundry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "microsoftFoundryName": {
            "value": "[parameters('microsoftFoundryName')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.40.2.10011",
              "templateHash": "13267883377033197505"
            }
          },
          "parameters": {
            "location": {
              "type": "string"
            },
            "microsoftFoundryName": {
              "type": "string"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[format('saml{0}', uniqueString(resourceGroup().id))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "StorageV2",
              "sku": {
                "name": "Standard_LRS"
              },
              "properties": {
                "accessTier": "Hot",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[format('kvml{0}', uniqueString(resourceGroup().id))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "enableRbacAuthorization": true,
                "enablePurgeProtection": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "publicNetworkAccess": "Enabled"
              }
            },
            {
              "type": "Microsoft.MachineLearningServices/workspaces",
              "apiVersion": "2023-10-01",
              "name": "[parameters('microsoftFoundryName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "friendlyName": "Zava Storefront AI",
                "description": "Microsoft Foundry for GPT-4 and Phi model access",
                "storageAccount": "[resourceId('Microsoft.Storage/storageAccounts', format('saml{0}', uniqueString(resourceGroup().id)))]",
                "keyVault": "[resourceId('Microsoft.KeyVault/vaults', format('kvml{0}', uniqueString(resourceGroup().id)))]",
                "publicNetworkAccess": "Enabled",
                "discoveryUrl": "[format('https://{0}.api.azureml.ms/discovery', parameters('location'))]",
                "v1LegacyMode": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', format('kvml{0}', uniqueString(resourceGroup().id)))]",
                "[resourceId('Microsoft.Storage/storageAccounts', format('saml{0}', uniqueString(resourceGroup().id)))]"
              ]
            }
          ],
          "outputs": {
            "foundryId": {
              "type": "string",
              "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('microsoftFoundryName'))]"
            },
            "foundryName": {
              "type": "string",
              "value": "[parameters('microsoftFoundryName')]"
            },
            "foundryPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.MachineLearningServices/workspaces', parameters('microsoftFoundryName')), '2023-10-01', 'full').identity.principalId]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "acrId": {
      "type": "string",
      "metadata": {
        "description": "Container Registry ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry'), '2025-04-01').outputs.registryId.value]"
    },
    "acrName": {
      "type": "string",
      "metadata": {
        "description": "Container Registry name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry'), '2025-04-01').outputs.registryName.value]"
    },
    "acrLoginServer": {
      "type": "string",
      "metadata": {
        "description": "Container Registry login server"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerRegistry'), '2025-04-01').outputs.loginServer.value]"
    },
    "webAppId": {
      "type": "string",
      "metadata": {
        "description": "Web App ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppId.value]"
    },
    "webAppName": {
      "type": "string",
      "metadata": {
        "description": "Web App name"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppName.value]"
    },
    "webAppUrl": {
      "type": "string",
      "metadata": {
        "description": "Web App URL"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.webAppUrl.value]"
    },
    "webAppPrincipalId": {
      "type": "string",
      "metadata": {
        "description": "Web App managed identity principal ID"
      },
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appService'), '2025-04-01').outputs.managedIdentityPrincipalId.value]"
    },
    "appInsightsId": {
      "type": "string",
      "metadata": {
        "description": "Application Insights ID (if enabled)"
      },
      "value": "[if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'applicationInsights'), '2025-04-01').outputs.appInsightsId.value, '')]"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "metadata": {
        "description": "Application Insights instrumentation key (if enabled)"
      },
      "value": "[if(parameters('enableAppInsights'), reference(resourceId('Microsoft.Resources/deployments', 'applicationInsights'), '2025-04-01').outputs.instrumentationKey.value, '')]"
    },
    "keyVaultUri": {
      "type": "string",
      "metadata": {
        "description": "Key Vault URI (if enabled)"
      },
      "value": "[if(parameters('enableKeyVault'), reference(resourceId('Microsoft.Resources/deployments', 'keyVault'), '2025-04-01').outputs.keyVaultUri.value, '')]"
    },
    "microsoftFoundryId": {
      "type": "string",
      "metadata": {
        "description": "Microsoft Foundry ID (if enabled)"
      },
      "value": "[if(parameters('enableMicrosoftFoundry'), reference(resourceId('Microsoft.Resources/deployments', 'microsoftFoundry'), '2025-04-01').outputs.foundryId.value, '')]"
    },
    "deploymentRegion": {
      "type": "string",
      "metadata": {
        "description": "Deployment region"
      },
      "value": "[parameters('location')]"
    },
    "environmentName": {
      "type": "string",
      "metadata": {
        "description": "Environment name"
      },
      "value": "[parameters('environment')]"
    },
    "resourceTags": {
      "type": "object",
      "metadata": {
        "description": "Resource tags"
      },
      "value": "[parameters('tags')]"
    }
  }
}